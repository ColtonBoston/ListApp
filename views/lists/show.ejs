<% include ../partials/header %>

<% var currentUserIsListOwner = list.author.id.equals(currentUser._id); %>

<div class="container">
  <h1><%= list.name %></h1>
  <p class="list-created-by"><em>Created by <strong><%= list.author.username %></strong> on <%= list.createdAt.toDateString() %></em></p>
  <script>document.write('<style>.js_hidden { display: none; }</style>');</script>
  <div class="row">
    <div class="col-sm-8">
      <ul id="list" class="list-group">
        <% if (list.items && list.items.length > 0){ %>
          <% var i = 0; %>
          <% list.items.forEach(function(item){ %>
            <li id="list-item-<%= i %>" class="list-group-item" data-added-by="<%= item.addedBy._id %>">
              <% if (currentUser && (item.addedBy.id.equals(currentUser._id) || list.author.id.equals(currentUser._id))) { %>
                <div class="list-item-text"><%= item.name %></div>
                <form class="edit-item-form js_hidden" action="/lists/<%= list._id %>/listItems/<%= item._id %>?_method=PUT" method="POST">
                  <input id="list-item-input-<%= i %>" class="list-item-input" name="item" type="text" value="<%= item.name %>">
                </form>
                <form class="delete-form js_hidden" action="/lists/<%= list._id %>/listItems/<%= item._id %>?_method=DELETE" method="post">
                  <button class="btn btn-danger btn-delete-item" type="submit"><i class="glyphicon glyphicon-remove"></i></button>
                </form>
              <% } else {%>
                <span><%= item.name %></span>
              <% } %>
              <div class="item-added-by"><small><em>added by <%= item.addedBy.username %></em></small></div>
            </li>
            <% i++ %>
          <% }) %>
        <% } %>
      </ul>
    </div>
    <div class="col-sm-4 list-actions">
      <form id="new-item-form" action="/lists/<%= list._id %>/listItems" method="POST">
        <input id="new-item-input" class="form-control new-item-input" type="text" name="item[name]" autocomplete="off" placeholder="New item...">
        <button id="new-item-submit" type="submit" class="btn btn-primary new-item-submit"><i class="glyphicon glyphicon-plus"></i></button>
      </form>
      <a id="btn-edit-item" href="/lists/<%= list._id %>/edit" class="btn btn-warning btn-edit-item"><i class="glyphicon glyphicon-edit"></i> Edit List</a>
      <h2 class="permissions-header">List permissions (<%= list.permissions.length %>)<i id="permissions-toggle" class="glyphicon glyphicon-menu-down"></i></h2>
      <ul class="list-group list-permissions">
        <div class="list-contents list-hidden">
          <li class="list-group-item permissions-li"><i class="glyphicon glyphicon-king list-author-icon"></i> <%= list.author.username %></li>
          <% list.permissions.forEach(function(permittedFriend){ %>
              <li class="list-group-item permissions-li">
                <% if(currentUser && currentUserIsListOwner){ %>
                  <span class="user-text"><%= permittedFriend.username %></span>
                  <form class="pull-right" action="/lists/<%= list.id %>/removePermission/<%= permittedFriend._id %>?_method=PUT" method="post">
                    <button type="submit" class="btn btn-sm btn-danger"><i class="glyphicon glyphicon-minus"></i></button>
                  </form>
                <% } else { %>
                  <%= permittedFriend.username %>
                <% } %>
              </li>
          <% }) %>
          <% if(currentUser && currentUserIsListOwner){ %>
            <% friends.forEach(function(friend){ %>
              <% console.log(friend) %>
              <li class="list-group-item permissions-li friend-unpermitted">
                <span class="user-text"><%= friend.username %></span>
                <form class="pull-right" action="/lists/<%= list.id %>/addPermission/<%= friend._id %>?_method=PUT" method="post">
                  <button type="submit" class="btn btn-sm btn-primary"><i class="glyphicon glyphicon-plus"></i></button>
                </form>
              </li>
            <% }) %>
          <% } %>
        </div>
      </ul>
      <% if (currentUser && currentUserIsListOwner){ %>
        <form class="delete-list-form" action="/lists/<%= list._id %>?_method=DELETE" method="post">
          <button id="btn-delete-list" class="btn btn-danger btn-delete-list"><i class="glyphicon glyphicon-trash"></i> Delete List</button>
        </form>
      <% } %>
    </div>
  </div>
</div>
<div class="notification">
  <span class="notification-message"></span>
</div>
<a id="btn-new-item" href="#new-item-input" class="btn btn-primary btn-new-item"><i class="glyphicon glyphicon-plus"></i></a>
<script type="text/javascript">var currentList = <%- JSON.stringify(list) %>;</script>
<script type="text/javascript" src="/scripts/editList.js"></script>
<% include ../partials/footer %>
